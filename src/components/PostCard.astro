---
import { getCollection, type CollectionEntry } from "astro:content";
import getPostUrl from "../scripts/postUrl";
import PostType from "./posts/PostType.astro";

interface Props {
    post: CollectionEntry<"posts">;
    url: string;
    showSeriesLink?: boolean;
}

const { post, showSeriesLink = true } = Astro.props;
const { date, type, tags, draft, series } = post.data;
const isDev = import.meta.env.DEV;

const year = date.getFullYear();
const month = date.toLocaleString("en-US", { month: "long" });
const day = String(date.getDate()).padStart(2, "0");

async function getSeriesTitle(series) {
    const allSeries = await getCollection('series');
    const postSeries = allSeries.find(s => s.slug === series);
    
    return postSeries.data.title;
}

---

<div class="py-4 border-b border-gray-200 last:border-0">
    <PostType post={post} />

    <div class="flex items-center gap-2 flex-wrap pt-4">
        <a
            href={getPostUrl(post)}
            class="text-sm text-green-700 hover:text-white hover:bg-green-800">&para;</a
        >
                
        <time class="text-sm text-gray-500" datetime={date.toISOString()}>
            <a class="hover:underline" href={`/${year}/${month}`}
                >{month.slice(0, 3)}</a
            >
            <a class="hover:underline" href={`/${year}/${month}/${day}`}
                >{day}</a
            >,
            <a class="hover:underline" href={`/${year}/`}>{year}</a>
        </time>
        
        <span class="inline-flex items-center rounded-md bg-gray-100 px-2 py-1 text-xs font-medium text-gray-600 inset-ring inset-ring-gray-500/10 dark:bg-gray-400/10 dark:text-gray-400 dark:inset-ring-gray-400/20">
            {type}
        </span>
        
        {
            draft && isDev && (
                <span class="inline-flex items-center gap-x-1.5 rounded-full bg-red-100 px-2 py-1 text-xs font-medium text-red-700 dark:bg-red-400/10 dark:text-red-400">
                  <svg viewBox="0 0 6 6" aria-hidden="true" class="size-1.5 fill-red-500 dark:fill-red-400">
                    <circle r="3" cx="3" cy="3" />
                  </svg>
                  Draft
                </span>
            )
        }
        {
            series && showSeriesLink && (
                <a
                    href={`/series/${series}`}
                    class="inline-flex items-center rounded-md bg-purple-50 px-2 py-1 text-xs font-medium text-purple-700 inset-ring inset-ring-purple-700/10 dark:bg-purple-400/10 dark:text-purple-400 dark:inset-ring-purple-400/30"
                >
                    ðŸ“š {getSeriesTitle(series)}
                </a>
            )
        }
        
        {
            tags &&
                tags.length > 0 &&
                tags.map((tag) => (
                    <a
                        href={`/tags/${tag}`}
                        class="inline-flex items-center rounded-md bg-amber-50 px-2 py-1 text-xs font-medium text-yellow-700 inset-ring inset-ring-yellow-700/10 dark:bg-yello-400/10 dark:text-yellow-400 dark:inset-ring-yellow-400/30"
                    >
                        #{tag}
                    </a>
                ))
        }
    </div>
</siv>

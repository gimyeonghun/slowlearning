---
import { getCollection, render } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import PostCard from "../../components/PostCard.astro";


export async function getStaticPaths() {
    const isDev = import.meta.env.DEV;
    
    const allSeries = await getCollection("series");
    const allPosts = await getCollection("posts");
    
    return allSeries.map((series) => {
        const seriesPosts = allPosts
                            .filter((post) => isDev || !post.data.draft)
                            .filter((post) => post.data.series == series.slug)
                            .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
        

        return {
            params: {id: series.slug},
            props: {series, seriesPosts},
        }
    })
}

const { series, seriesPosts } = Astro.props;
const { title } = series.data;
const { Content } = await render(series);

function getPostUrl(post: (typeof posts)[0]) {
    const date = post.data.date;
    const year = date.getFullYear();
    const month = date.toLocaleString("en-US", { month: "long" });
    const day = String(date.getDate()).padStart(2, "0");
    const slug = post.slug.replace(/^\d{4}-\d{2}-\d{2}-/, "");
    return `/${year}/${month}/${day}/${slug}`;
}
---

<BaseLayout title={`Series: ${title}`}>
    <h1 class="text-3xl font-bold mb-8">{title}</h1>
    <Content />
    
    <div class="space-y-0 pt-8">
    {
        seriesPosts.map(async (post) => {
            const { Content } = await post.render();
            return (
                <PostCard post={post} url={getPostUrl(post)}>
                    <Content />
                </PostCard>
            );
        })}
    </div>
</BaseLayout>

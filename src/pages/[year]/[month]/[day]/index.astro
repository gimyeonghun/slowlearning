---
import { getCollection } from "astro:content";
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import PostCard from "../../../../components/PostCard.astro";

import getPostUrl from "../../../../scripts/postUrl";

export async function getStaticPaths() {
    const POSTS_PER_PAGE = 10;
    const isDev = import.meta.env.DEV;
    const allPosts = (await getCollection("posts")).filter(
        (post) => isDev || !post.data.draft,
    );
    const dates = [
        ...new Set(
            allPosts.map((post) => {
                const date = post.data.date;
                return `${date.getFullYear()}-${date.toLocaleString("en-US", { month: "long" })}-${String(date.getDate()).padStart(2, "0")}`;
            }),
        ),
    ];

    return dates.flatMap((dateStr) => {
        const [year, month, day] = dateStr.split("-");
        const dayPosts = allPosts
            .filter((post) => {
                const date = post.data.date;
                return (
                    date.getFullYear() === parseInt(year) &&
                    date.toLocaleString("en-US", { month: "long" }) === month &&
                    String(date.getDate()).padStart(2, "0") === day
                );
            })
            .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

        const totalPages = Math.ceil(dayPosts.length / POSTS_PER_PAGE);

        return Array.from({ length: totalPages }, (_, i) => {
            const page = i + 1;
            const start = (page - 1) * POSTS_PER_PAGE;
            const end = start + POSTS_PER_PAGE;

            return {
                params: { year, month, day },
                props: {
                    posts: dayPosts.slice(start, end),
                    year,
                    month,
                    day,
                    currentPage: page,
                    totalPages,
                },
            };
        });
    });
}

const { posts, year, month, day, currentPage, totalPages } = Astro.props;
---

<BaseLayout title={`Posts from ${month} ${day}, ${year}`}>
    <h1 class="text-3xl font-bold mb-8">Posts from {month} {day}, {year}</h1>

    <div class="space-y-0">
        {
            posts.map(async (post) => {
                const { Content } = await post.render();
                return (
                    <PostCard post={post} url={getPostUrl(post)}>
                        <Content />
                    </PostCard>
                );
            })
        }
    </div>

    {
        totalPages > 1 && (
            <nav
                class="flex justify-center gap-2 mt-12"
                aria-label="Pagination"
            >
                {currentPage > 1 && (
                    <a
                        href={`/${year}/${month}/${day}?page=${currentPage - 1}`}
                        class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded"
                    >
                        ← Previous
                    </a>
                )}

                {Array.from({ length: totalPages }, (_, i) => i + 1).map(
                    (page) =>
                        page === currentPage ? (
                            <span class="px-4 py-2 bg-blue-600 text-white rounded">
                                {page}
                            </span>
                        ) : (
                            <a
                                href={`/${year}/${month}/${day}?page=${page}`}
                                class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded"
                            >
                                {page}
                            </a>
                        ),
                )}

                {currentPage < totalPages && (
                    <a
                        href={`/${year}/${month}/${day}?page=${currentPage + 1}`}
                        class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded"
                    >
                        Next →
                    </a>
                )}
            </nav>
        )
    }
</BaseLayout>

---
import { getCollection } from "astro:content";
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import PostType from "../../../../components/posts/PostType.astro";

export async function getStaticPaths() {
    const isDev = import.meta.env.DEV;

    const posts = (await getCollection("posts")).filter(
        (post) => isDev || !post.data.draft,
    );

    return posts.map((post) => {
        const date = post.data.date;
        const year = date.getFullYear();
        const month = date.toLocaleString("en-US", { month: "long" });
        const day = String(date.getDate()).padStart(2, "0");
        const slug = post.slug.replace(/^\d{4}-\d{2}-\d{2}-/, "");

        return {
            params: { year: String(year), month, day, slug },
            props: { post },
        };
    });
}

const { post } = Astro.props;
const { title, date, type, tags, draft, series } = post.data;

const formattedDate = new Intl.DateTimeFormat("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
}).format(date);

async function getSeriesTitle(series) {
    const allSeries = await getCollection("series");
    const postSeries = allSeries.find((s) => s.slug === series);

    return postSeries.data.title;
}

const slug = post.slug.replace(/^\d{4}-\d{2}-\d{2}-/, "");
---

<BaseLayout title={title}>
    <Fragment slot="main">
        <header>
            {
                draft && (
                    <span class="inline-flex items-center gap-x-1.5 rounded-full bg-red-100 px-2 py-1 text-xs font-medium text-red-700 dark:bg-red-400/10 dark:text-red-400">
                        <svg
                            viewBox="0 0 6 6"
                            aria-hidden="true"
                            class="size-1.5 fill-red-500 dark:fill-red-400"
                        >
                            <circle r="3" cx="3" cy="3" />
                        </svg>
                        Draft
                    </span>
                )
            }
        </header>
        <PostType post={post} detail={true} />
        {
            tags && tags.length > 0 && (
                <footer class="flex gap-2 flex-wrap pt-6 pb-4">
                    {tags.map((tag) => (
                        <a
                            href={`/tags/${tag}`}
                            class="inline-flex items-center rounded-md bg-amber-50 px-2 py-1 text-xs font-medium text-yellow-700 inset-ring inset-ring-yellow-700/10 dark:bg-yello-400/10 dark:text-yellow-400 dark:inset-ring-yellow-400/30"
                        >
                            #{tag}
                        </a>
                    ))}
                </footer>
            )
        }
    </Fragment>
    <Fragment slot="side-bar">
        <p class="text-sm/7 text-zinc-600">
            The <span
                class="px-2 py-1 rounded bg-gray-200 text-gray-700 text-xs"
                >{type}</span
            > "<a
                href={slug}
                class="text-green-700 underline hover:text-white hover:bg-green-800"
                >{title}</a
            >" by Brian Kim was published on <time datetime={date.toISOString()}
                >{formattedDate}</time
            >.
        </p>

        {
            series && (
                <div class="pt-4 text-sm/7 text-zinc-600">
                    Part of the series
                    <a
                        href={`/series/${series}`}
                        class="inline-flex items-center rounded-md bg-purple-50 px-2 py-1 text-xs font-medium text-purple-700 inset-ring inset-ring-purple-700/10 dark:bg-purple-400/10 dark:text-purple-400 dark:inset-ring-purple-400/30"
                    >
                        ğŸ“š {getSeriesTitle(series)}
                    </a>
                </div>
            )
        }
    </Fragment>
</BaseLayout>

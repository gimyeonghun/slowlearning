---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import PostCard from "../components/PostCard.astro";

const isDev = import.meta.env.DEV;

// Redirect to home if not in development
if (!isDev) {
    return Astro.redirect("/");
}

const draftPosts = (await getCollection("posts"))
    .filter((post) => post.data.draft)
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

function getPostUrl(post: (typeof draftPosts)[0]) {
    const date = post.data.date;
    const year = date.getFullYear();
    const month = date.toLocaleString("en-US", { month: "long" });
    const day = String(date.getDate()).padStart(2, "0");
    const slug = post.slug.replace(/^\d{4}-\d{2}-\d{2}-/, "");
    return `/${year}/${month}/${day}/${slug}`;
}
---

<BaseLayout title="Draft Posts - Slow Learner Quest">
    <div class="mb-8">
        <h1 class="text-3xl font-bold mb-2">Draft Posts</h1>
        <p class="text-gray-600">
            These posts are only visible in development mode. Set <code
                class="bg-gray-200 px-1 py-0.5 rounded text-sm"
                >draft: false</code
            > to publish.
        </p>
    </div>

    {
        draftPosts.length === 0 ? (
            <div class="text-center py-12 text-gray-500">
                <p class="text-lg">No draft posts found.</p>
                <p class="mt-2">
                    Create a post with{" "}
                    <code class="bg-gray-200 px-1 py-0.5 rounded text-sm">
                        draft: true
                    </code>{" "}
                    in the frontmatter.
                </p>
            </div>
        ) : (
            <div class="space-y-0">
                {draftPosts.map(async (post) => {
                    const { Content } = await post.render();
                    return (
                        <PostCard post={post} url={getPostUrl(post)}>
                            <Content />
                        </PostCard>
                    );
                })}
            </div>
        )
    }
</BaseLayout>

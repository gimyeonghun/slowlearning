---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import PostCard from "../components/PostCard.astro";

const POSTS_PER_PAGE = 10;
const isDev = import.meta.env.DEV;

const allPosts = (await getCollection("posts"))
    .filter((post) => isDev || !post.data.draft)
    .filter((post) => !post.data.hide)
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const currentPage = 1;
const totalPages = Math.ceil(allPosts.length / POSTS_PER_PAGE);
const paginatedPosts = allPosts.slice(0, POSTS_PER_PAGE);

function getPostUrl(post: (typeof allPosts)[0]) {
    const date = post.data.date;
    const year = date.getFullYear();
    const month = date.toLocaleString("en-US", { month: "long" });
    const day = String(date.getDate()).padStart(2, "0");
    const slug = post.slug.replace(/^\d{4}-\d{2}-\d{2}-/, "");
    return `/${year}/${month}/${day}/${slug}`;
}
---

<BaseLayout title="Home">
    <div class="space-y-0">
        {
            paginatedPosts.map(async (post) => {
                const { Content } = await post.render();
                return (
                    <PostCard post={post} url={getPostUrl(post)}>
                        <Content />
                    </PostCard>
                );
            })
        }
    </div>

    {
        totalPages > 1 && (
            <nav
                class="flex justify-center gap-2 mt-12"
                aria-label="Pagination"
            >
                <span class="px-4 py-2 bg-blue-600 text-white rounded">1</span>
                {Array.from({ length: totalPages - 1 }, (_, i) => i + 2).map(
                    (page) => (
                        <a
                            href={`/page/${page}`}
                            class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded"
                        >
                            {page}
                        </a>
                    ),
                )}
            </nav>
        )
    }
</BaseLayout>
